---
language: python
python:
  - '2.7'
  - '3.6'
sudo: true
services:
  - docker
env:
  matrix:
    - UMD_VERSION=default
    - UMD_VERSION=umd4
  global:
    - TEST_ROLE_PATH=$PWD/
    - GITHUB_REPO=ansible-role-umd
addons:
  apt:
    packages:
      - python-pip
      - ruby
      - ruby-dev
      - ruby-full
install:
  - pip install -r requirements.txt
  - gem update --system
  - gem install httparty awesome_print inspec
before_script:
# - CONTROLS=("'Travis'" "'Meta'" "'Ansible main YAML files'" "'Ansible Skeleton Directories'") inspec supermarket exec brucellino/ansible-fashion-police --controls=${CONTROLS[*]}
#   - GITHUB_REPO=$TRAVIS_SLUG inspec supermarket exec brucellino/black-panther
script:
  - molecule dependency -s $UMD_VERSION
  - molecule lint -s $UMD_VERSION
  - molecule syntax -s $UMD_VERSION
  - molecule converge -s $UMD_VERSION
  - molecule verify -s $UMD_VERSION
after_success:
  # push to Travis
  - docker commit umd-centos7 quay.io/egi/umd4:centos7
  - docker commit umd-centos6 quay.io/egi/umd4:centos6
  - echo $TRAVIS_PULL_REQUEST
  - 'if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then docker login -u="egi+packerbot" -p=${QUAY_PASSWORD} quay.io ; fi'
  - 'if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then docker push quay.io/egi/umd4:centos6 ; fi'
  - 'if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then docker push quay.io/egi/umd4:centos7 ; fi'
notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
  slack:
    secure:
